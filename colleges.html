<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colleges | Pathfinder</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070c1e; --panel:#0f1533; --muted:#9aa4c7; --text:#eaf0ff; --accent:#4da3ff; --accent-2:#7cc8ff;
      --ok:#1ed760; --warn:#ffcc00; --danger:#ff5c5c; --line:#243066; --glass:linear-gradient(180deg,#10183a,#0c1230);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    a{color:var(--text);text-decoration:none}

    /* ===== SUPER COOL ANIMATED BACKGROUND (CSS-only, no libs) ===== */
    .bg{position:fixed;inset:0;z-index:-2;overflow:hidden}
    /* subtle starfield */
    .bg:before{content:"";position:absolute;inset:-20%;background:
      radial-gradient(2px 2px at 20% 30%,#9fb2ff88,transparent 60%),
      radial-gradient(1.5px 1.5px at 70% 20%,#9fb2ff66,transparent 60%),
      radial-gradient(1.7px 1.7px at 40% 70%,#7cc8ff66,transparent 60%),
      radial-gradient(1.3px 1.3px at 85% 60%,#c7d6ff55,transparent 60%),
      radial-gradient(1.2px 1.2px at 55% 45%,#7aa7ff55,transparent 60%),
      radial-gradient(1.2px 1.2px at 10% 80%,#7aa7ff55,transparent 60%),
      radial-gradient(1.2px 1.2px at 92% 12%,#7aa7ff55,transparent 60%);
      filter:drop-shadow(0 0 4px #9fb2ff66);
      animation: drift 120s linear infinite;
    }
    @keyframes drift{to{transform:translate3d(-2%, -4%, 0)}}
    /* moving holographic orbs */
    .orb{position:absolute;filter:blur(45px) saturate(115%);opacity:.55}
    .orb.one{width:40vw;height:40vw;left:-10vw;top:-10vw;background:radial-gradient(circle at 30% 30%,#2745ff,transparent 55%), radial-gradient(circle at 60% 70%,#00e1ff,transparent 55%);animation: float1 22s ease-in-out infinite}
    .orb.two{width:45vw;height:45vw;right:-15vw;top:10vh;background:radial-gradient(circle at 60% 40%,#7a30ff,transparent 55%), radial-gradient(circle at 30% 60%,#00d1ff,transparent 55%);animation: float2 28s ease-in-out infinite}
    .orb.three{width:55vw;height:55vw;left:10vw;bottom:-20vh;background:radial-gradient(circle at 40% 50%,#00ffa6,transparent 55%), radial-gradient(circle at 70% 30%,#3a63ff,transparent 55%);animation: float3 32s ease-in-out infinite}
    @keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(6vh)}}
    @keyframes float2{0%,100%{transform:translateY(0)}50%{transform:translateY(-4vh)}}
    @keyframes float3{0%,100%{transform:translateY(0)}50%{transform:translateY(8vh)}}
    /* tech grid overlay */
    .grid-overlay{position:absolute;inset:0;pointer-events:none;opacity:.08;background:
      linear-gradient(transparent 96%, #7aa7ff 96%),
      linear-gradient(90deg, transparent 96%, #7aa7ff 96%);
      background-size: 22px 22px, 22px 22px;
      mask-image: radial-gradient(circle at 60% 20%, black 0 35%, transparent 60%);
      animation: gridGlow 8s ease-in-out infinite alternate;
    }
    @keyframes gridGlow{to{opacity:.14;filter:hue-rotate(20deg)}}

    .container{max-width:1280px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:rgba(11,16,32,.7);backdrop-filter: blur(10px);border-bottom:1px solid #1b2550;z-index:20}
    nav{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;letter-spacing:.4px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent)}
    .links{display:flex;gap:8px;align-items:center}
    .iconbtn{border:1px solid #223068;background:#0b1332;border-radius:12px;padding:8px 10px;cursor:pointer}
    .link{padding:8px 12px;border-radius:12px;color:var(--muted);border:1px solid transparent}
    .link:hover{color:var(--text);border-color:#273064;background:linear-gradient(180deg,#121a3b,#0e1633)}
    .active{color:var(--text);border:1px solid #2a3a7a;background:linear-gradient(180deg,#19245a,#121a3f);box-shadow:0 0 0 1px #1f2b5e inset}

    h1{font-size:32px;margin:18px 0 8px}
    p.lead{color:var(--muted);margin:0 0 18px}

    .panel{background:var(--glass);border:1px solid #233068;border-radius:18px;padding:20px;box-shadow:0 14px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02)}

    /* Typewriter coach */
    .coach{display:flex;align-items:center;gap:8px;border:1px solid #223068;background:#0a1331AA;padding:12px 14px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .coach .caret{width:10px;height:18px;background:#8fb8ff;display:inline-block;margin-left:4px;animation:blink 1s steps(1) infinite}
    @keyframes blink{50%{opacity:0}}
    .coach .dots{display:inline-flex;gap:4px;margin-left:6px}
    .coach .dot{width:6px;height:6px;border-radius:50%;background:#9fb2ff;opacity:.4;animation:bounce 1s infinite ease-in-out}
    .coach .dot:nth-child(2){animation-delay:.15s}.coach .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-4px);opacity:1}}

    /* Stepper */
    .stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
    .step{background:#0b1332;border:1px solid #223068;border-radius:12px;padding:10px;text-align:center;color:#9fb2ff}
    .step.active{background:#14205a;color:#fff;border-color:#2e4dac}

    /* Inputs */
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:14px 16px;border-radius:12px;background:#0a1331;border:1px solid #243470;color:var(--text);font-size:15px}
    input:focus,select:focus,button:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.25)}
    button{cursor:pointer;background:linear-gradient(180deg,#1c3f86,#17346f);border-color:#2a56a6;font-weight:700}
    button:hover{transform:translateY(-1px)}

    .note{font-size:12px;color:var(--muted)}

    /* COLLAPSIBLE FILTERS */
    .collapse{border-top:1px dashed #223068;margin-top:12px;padding-top:12px}
    .collapse summary{cursor:pointer;list-style:none}
    .collapse summary::-webkit-details-marker{display:none}

    /* TABLE */
    .table-wrap{overflow:auto;border-radius:14px}
    table{width:100%;min-width:780px;border-collapse:separate;border-spacing:0 12px}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#a9b4db;text-align:left;padding:10px 12px}
    tbody td{padding:16px 14px;background:#0b1332;border:1px solid #273777;vertical-align:top;font-size:15px}
    tbody tr{border-radius:12px}
    tbody td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;display:inline-block}
    .safety{background:rgba(30,215,96,.15);color:#9af2bb;border:1px solid rgba(30,215,96,.35)}
    .target{background:rgba(255,204,0,.12);color:#ffe08a;border:1px solid rgba(255,204,0,.35)}
    .reach{background:rgba(255,92,92,.14);color:#ffb3b3;border:1px solid rgba(255,92,92,.35)}
    .why{font-size:12.5px;color:#c8d3ff;margin-top:10px;border-top:1px dashed var(--line);padding-top:10px}
    .mini-link{font-size:12px;border:1px solid #2a3a7a;border-radius:999px;padding:6px 10px;background:#0a1331;display:inline-block}

    /* Sticky action bar */
    .actionbar{position:sticky;bottom:0;left:0;right:0;background:rgba(10,15,30,.85);backdrop-filter:blur(8px);border-top:1px solid #223068;padding:10px;display:flex;justify-content:space-between;align-items:center;z-index:15}

    /* Drawer (Bookmarks) */
    .drawer{position:fixed;top:64px;right:16px;width:360px;max-width:92vw;background:var(--panel);border:1px solid #233068;border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.45);padding:14px;display:none;z-index:30}
    .drawer.open{display:block}
    .bm-empty{color:var(--muted);font-size:13px}
    .bm-item{border:1px solid #273777;background:#0b1332;border-radius:12px;padding:12px;margin-bottom:10px}
    .bm-title{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .bm-title h4{margin:0;font-size:14px}
    .bm-meta{font-size:12px;color:#a9b4db;margin:4px 0}
    .bm-actions{display:flex;gap:6px}
    .star{cursor:pointer;user-select:none}
    .star.filled{filter:drop-shadow(0 0 6px var(--accent))}

    /* ===== Animated view transitions (slides + fades) ===== */
    .views{position:relative;min-height:140px}
    .view{position:relative}
    @media (min-width:800px){.view{display:grid;grid-template-columns:1fr 200px;gap:12px}}
    .view.hidden{display:none}

    .slide{position:relative}
    .slide-enter-right{animation:enterRight .35s cubic-bezier(.25,.8,.25,1)}
    .slide-exit-left{animation:exitLeft .32s cubic-bezier(.25,.8,.25,1)}
    .slide-enter-left{animation:enterLeft .35s cubic-bezier(.25,.8,.25,1)}
    .slide-exit-right{animation:exitRight .32s cubic-bezier(.25,.8,.25,1)}
    @keyframes enterRight{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
    @keyframes exitLeft{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-28px)}}
    @keyframes enterLeft{from{opacity:0;transform:translateX(-28px)}to{opacity:1;transform:translateX(0)}}
    @keyframes exitRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(28px)}}
  </style>
</head>
<body>
  <!-- Animated background layers -->
  <div class="bg">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
    <div class="grid-overlay"></div>
  </div>

  <header>
    <div class="container">
      <nav>
        <div class="brand"><span class="dot"></span> Pathfinder</div>
        <div class="links">
          <a class="link" href="index.html">Home</a>
          <a class="link" href="explore.html">Explore</a>
          <a class="link active" href="colleges.html">Colleges</a>
          <button id="shareBtn" class="iconbtn" title="Save & copy shareable link">üîó</button>
          <button id="bmBtn" class="iconbtn" title="Bookmarks">‚≠ê</button>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Find Your Best‚ÄëFit Colleges</h1>
    <div class="panel coach" aria-live="polite">
      <div id="coachText">Welcome!</div>
      <span class="caret"></span>
      <div class="dots" id="coachDots" style="display:none"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    </div>

    <section class="panel" style="margin-top:12px">
      <div class="stepper" aria-label="progress">
        <div class="step active" id="s1">1. GPA</div>
        <div class="step" id="s2">2. Major</div>
        <div class="step" id="s3">3. Results</div>
      </div>

      <div class="views">
        <!-- STEP 1 -->
        <div id="view1" class="view slide">
          <div>
            <label for="gpa">Weighted GPA (can be above 4.0)</label>
            <input id="gpa" type="number" min="0" max="5.00" step="0.01" placeholder="e.g., 4.18" />
          </div>
          <div style="align-self:end"><button id="toStep2">Next ‚Üí</button></div>
        </div>
        <!-- STEP 2 -->
        <div id="view2" class="view slide hidden">
          <div>
            <label for="major">Major</label>
            <input list="majors" id="major" placeholder="Start typing‚Ä¶ e.g., Electrical Engineering" />
            <datalist id="majors"></datalist>
          </div>
          <div style="display:flex;gap:8px;align-items:end">
            <button id="back1">‚Üê Back</button>
            <button id="run">Show Results</button>
          </div>
        </div>
      </div>

      <details class="collapse" id="filters">
        <summary><strong>Filters</strong></summary>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
          <label>System
            <select id="system">
              <option value="ALL">All</option>
              <option value="UC">UC</option>
              <option value="CSU">CSU</option>
              <option value="Private">Private</option>
            </select>
          </label>
          <label>Min admit rate
            <select id="minrate">
              <option value="0">Any</option>
              <option value="10">‚â• 10%</option>
              <option value="20">‚â• 20%</option>
              <option value="30">‚â• 30%</option>
            </select>
          </label>
        </div>
      </details>

      <p class="note" style="margin-top:10px">Badges use placeholder midpoints & rates. Replace the <code>COLLEGES</code> dataset with verified values when ready.</p>
    </section>

    <section class="panel">
      <div class="table-wrap" id="tableWrap"><div id="results" aria-live="polite"></div></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px" id="legend">
        <span class="mini-link"><span class="tag safety">Safety</span> GPA ‚â• midpoint + 0.20</span>
        <span class="mini-link"><span class="tag target">Target</span> |GPA ‚àí midpoint| ‚â§ 0.15</span>
        <span class="mini-link"><span class="tag reach">Reach</span> GPA ‚â§ midpoint ‚àí 0.16</span>
      </div>
    </section>

    <div class="actionbar">
      <div id="count" class="note">No results yet.</div>
      <div style="display:flex;gap:8px">
        <button id="toggleDetails">Toggle details</button>
        <button id="analyze">Re-run</button>
      </div>
    </div>

    <aside class="drawer" id="drawer">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Bookmarks</strong>
        <div>
          <button id="clearBms" class="mini-link">Clear</button>
          <button id="closeDrawer" class="mini-link">Close</button>
        </div>
      </div>
      <div id="bmList"></div>
    </aside>
  </main>

  <script>
    // ===== Majors =====
    const MAJORS = [
      "Electrical Engineering","Civil Engineering","Mechanical Engineering","Materials Science",
      "Computer Science","Business Administration","Finance","Mathematics","Psychology","Nursing","Liberal Arts"
    ];

    // ===== Dataset (demo) =====
    const COLLEGES = [
      {name:"UC Berkeley", system:"UC", midGpa:4.25, admitRate:12, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Mathematics","Materials Science","Liberal Arts"], midByMajor:{"Electrical Engineering":4.28,"Computer Science":4.30,"Mathematics":4.18,"Liberal Arts":4.08}},
      {name:"UCLA", system:"UC", midGpa:4.23, admitRate:11, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Psychology","Mathematics","Liberal Arts"], midByMajor:{"Electrical Engineering":4.26,"Computer Science":4.29,"Psychology":4.15,"Mathematics":4.17,"Liberal Arts":4.05}},
      {name:"UC San Diego", system:"UC", midGpa:4.15, admitRate:24, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Mathematics","Materials Science","Liberal Arts"], midByMajor:{"Computer Science":4.22,"Electrical Engineering":4.18,"Mathematics":4.06,"Liberal Arts":3.98}},
      {name:"UC Santa Barbara", system:"UC", midGpa:4.10, admitRate:26, majors:["Mechanical Engineering","Computer Science","Mathematics","Psychology","Liberal Arts"], midByMajor:{"Mechanical Engineering":4.16,"Computer Science":4.14,"Mathematics":4.02,"Liberal Arts":3.95}},
      {name:"UC Irvine", system:"UC", midGpa:4.08, admitRate:28, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Business Administration","Nursing","Liberal Arts"], midByMajor:{"Nursing":4.20,"Computer Science":4.14,"Electrical Engineering":4.06,"Business Administration":3.98,"Liberal Arts":3.90}},
      {name:"UC Davis", system:"UC", midGpa:4.02, admitRate:37, majors:["Mechanical Engineering","Computer Science","Psychology","Mathematics","Materials Science","Nursing","Liberal Arts"]},
      {name:"UC Santa Cruz", system:"UC", midGpa:3.90, admitRate:51, majors:["Computer Science","Mathematics","Psychology","Liberal Arts"]},
      {name:"UC Riverside", system:"UC", midGpa:3.85, admitRate:57, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Business Administration","Liberal Arts"]},
      {name:"UC Merced", system:"UC", midGpa:3.78, admitRate:86, majors:["Mechanical Engineering","Computer Science","Mathematics","Liberal Arts"]},
      {name:"Cal Poly SLO", system:"CSU", midGpa:4.05, admitRate:29, majors:["Electrical Engineering","Mechanical Engineering","Materials Science","Business Administration","Computer Science","Mathematics","Liberal Arts"], midByMajor:{"Computer Science":4.10,"Mechanical Engineering":4.08,"Liberal Arts":3.85}},
      {name:"Cal Poly Pomona", system:"CSU", midGpa:3.86, admitRate:45, majors:["Electrical Engineering","Mechanical Engineering","Civil Engineering","Computer Science","Business Administration","Mathematics","Liberal Arts"]},
      {name:"San Diego State", system:"CSU", midGpa:3.90, admitRate:38, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Business Administration","Nursing","Mathematics","Liberal Arts"], midByMajor:{"Nursing":4.00,"Computer Science":3.95}},
      {name:"San Jos√© State", system:"CSU", midGpa:3.85, admitRate:54, majors:["Electrical Engineering","Mechanical Engineering","Computer Science","Business Administration","Mathematics","Liberal Arts"]},
      {name:"Long Beach State", system:"CSU", midGpa:3.80, admitRate:42, majors:["Mechanical Engineering","Civil Engineering","Computer Science","Business Administration","Mathematics","Liberal Arts"]},
      {name:"CSU Fullerton", system:"CSU", midGpa:3.70, admitRate:59, majors:["Computer Science","Business Administration","Finance","Psychology","Mathematics","Liberal Arts"]},
      {name:"CSU Northridge", system:"CSU", midGpa:3.60, admitRate:66, majors:["Mechanical Engineering","Civil Engineering","Computer Science","Business Administration","Psychology","Mathematics","Liberal Arts"]},
      {name:"San Francisco State", system:"CSU", midGpa:3.55, admitRate:84, majors:["Business Administration","Computer Science","Psychology","Mathematics","Liberal Arts"]},
      {name:"USC", system:"Private", midGpa:4.15, admitRate:12, majors:["Business Administration","Computer Science","Mechanical Engineering","Electrical Engineering","Mathematics","Liberal Arts"], midByMajor:{"Business Administration":4.05,"Computer Science":4.18}},
      {name:"Stanford", system:"Private", midGpa:4.30, admitRate:4, majors:["Computer Science","Mathematics","Electrical Engineering","Liberal Arts"], midByMajor:{"Computer Science":4.33,"Mathematics":4.25}}
    ];

    // ===== Helpers =====
    const majorsDL = document.getElementById('majors');
    MAJORS.forEach(m => majorsDL.insertAdjacentHTML('beforeend', `<option value="${m}"></option>`));
    const getMidpoint = (college, major) => (college.midByMajor && college.midByMajor[major]) ? college.midByMajor[major] : college.midGpa;
    const admissionsUrl = (name) => `https://www.google.com/search?q=${encodeURIComponent(name+' undergraduate admissions')}`;
    const fitTagClass = (b) => b==='Safety'?'safety':(b==='Target'?'target':'reach');
    function classify(gpa, midpoint){ if (isNaN(gpa) || isNaN(midpoint)) return {band:"‚Äî", diff:NaN}; const diff = +(gpa - midpoint).toFixed(2); if (diff >= 0.20) return {band:"Safety", diff}; if (Math.abs(diff) <= 0.15) return {band:"Target", diff}; return {band:"Reach", diff}; }
    function reasonText({gpa, mid, band, name, major}){ const delta = +(gpa - mid).toFixed(2); const aboveBelow = delta >= 0 ? 'above' : 'below'; const abs = Math.abs(delta).toFixed(2); return `${major?`<strong>${major}</strong> at ${name}`:name}: midpoint <strong>${mid.toFixed(2)}</strong>. Your GPA is <strong>${abs}</strong> ${aboveBelow} ‚Üí <strong>${band}</strong>.`; }

    // ===== Bookmarks (drawer, localStorage) =====
    const LS_KEYS = {BOOKMARKS:'pf_bookmarks', PROFILE:'pf_profile'};
    const getJSON = (k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f;}catch{return f;}};
    const setJSON = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const bookmarkKey = (b)=>`${b.name}|${b.major}`;
    const loadBookmarks = ()=>getJSON(LS_KEYS.BOOKMARKS, []);
    const saveBookmarks = (arr)=>{setJSON(LS_KEYS.BOOKMARKS, arr); renderBookmarks();};
    const isBookmarked = (name, major)=>loadBookmarks().some(b=>b.name===name && b.major===major);
    const addBookmark = (bm)=>{const arr=loadBookmarks(); if(!isBookmarked(bm.name,bm.major)){arr.push(bm); saveBookmarks(arr);} };
    const removeBookmark = (n,m)=>saveBookmarks(loadBookmarks().filter(b=>!(b.name===n && b.major===m)));

    function renderBookmarks(){
      const list = loadBookmarks();
      const box = document.getElementById('bmList');
      if (!list.length){ box.innerHTML = `<p class="bm-empty">No bookmarks yet. Click ‚òÖ in the results to save a college.</p>`; return; }
      box.innerHTML = list.map(b=>{
        const tag = fitTagClass(b.band);
        return `<div class="bm-item" data-k="${bookmarkKey(b)}">
          <div class="bm-title"><h4>${b.name}</h4>
            <div class="bm-actions">
              <span class="tag ${tag}">${b.band}</span>
              <a class="mini-link" target="_blank" href="${admissionsUrl(b.name)}">Admissions</a>
              <button class="mini-link" data-act="remove">Remove</button>
            </div></div>
          <div class="bm-meta">${b.system} ‚Ä¢ ${b.major} ‚Ä¢ Mid ${b.mid.toFixed(2)} ‚Ä¢ GPA ${b.gpa.toFixed(2)} ‚Ä¢ Œî ${(b.gpa-b.mid).toFixed(2)}</div>
        </div>`;
      }).join('');
      box.querySelectorAll('[data-act="remove"]').forEach(btn=>{
        const k = btn.closest('.bm-item').dataset.k; const [n,m]=k.split('|');
        btn.addEventListener('click',()=>removeBookmark(n,m));
      });
    }

    // ===== Typewriter coach =====
    const coachText = document.getElementById('coachText');
    const coachDots = document.getElementById('coachDots');
    let typing=false; let typeQueue=Promise.resolve();
    function typeLine(text, speed=22){ return new Promise(resolve=>{ typing=true; coachDots.style.display='none'; coachText.textContent=''; let i=0; const t=setInterval(()=>{ coachText.textContent += text.charAt(i++); if(i>=text.length){ clearInterval(t); typing=false; resolve(); } }, speed); }); }
    function say(text){ typeQueue = typeQueue.then(()=>typeLine(text)); return typeQueue; }
    function thinking(on=true){ coachDots.style.display = on ? 'inline-flex' : 'none'; }

    // ===== Animated step transitions =====
    const s1=document.getElementById('s1'), s2=document.getElementById('s2'), s3=document.getElementById('s3');
    const v1=document.getElementById('view1');
    const v2=document.getElementById('view2');
    const gpa=document.getElementById('gpa');
    const major=document.getElementById('major');

    function setStep(n){ [s1,s2,s3].forEach((el,i)=> el.classList.toggle('active', i===n-1)); }

    function show(from, to, dir){
      if(from===to) return;
      const enter = dir==='forward' ? 'slide-enter-right' : 'slide-enter-left';
      const exit  = dir==='forward' ? 'slide-exit-left' : 'slide-exit-right';
      from.classList.add(exit);
      to.classList.remove('hidden');
      to.classList.add(enter);
      const clean = (el, cls)=> el.addEventListener('animationend', function h(){ el.classList.remove(cls); el.removeEventListener('animationend', h); if(el===from) el.classList.add('hidden'); });
      clean(from, exit);
      clean(to, enter);
    }

    function toStep2(){ setStep(2); show(v1, v2, 'forward'); major.focus(); }
    function backToStep1(){ setStep(1); show(v2, v1, 'back'); gpa.focus(); }

    document.getElementById('toStep2').addEventListener('click', toStep2);
    document.getElementById('back1').addEventListener('click', backToStep1);

    // Validation & auto-advance
    const MAJOR_SET = new Set(MAJORS.map(m=>m.toLowerCase()));
    const validGpa = ()=>{ const v=parseFloat(gpa.value); return !isNaN(v)&&v>=0&&v<=5; };
    const matchesMajor = (val)=> MAJOR_SET.has((val||'').toLowerCase().trim());

    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }

    gpa.addEventListener('input', debounce(()=>{ if(validGpa()){ say('Nice. Now choose your intended major.').then(toStep2); } }, 380));
    gpa.addEventListener('keydown', e=>{ if(e.key==='Enter'&&validGpa()){ e.preventDefault(); toStep2(); }});

    function goResults(){ setStep(3); thinking(true); say('Crunching your matches').then(()=>{ setTimeout(()=>{ analyze(); thinking(false); }, 420); }); }
    major.addEventListener('change', ()=>{ if(matchesMajor(major.value)) goResults(); });
    major.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); if(matchesMajor(major.value)) goResults(); }});

    // ===== Share (profile in URL + clipboard) =====
    function getProfile(){return {gpa: gpa.value, major: major.value, system: system.value, minrate: minrate.value};}
    function applyProfile(p){ if(!p) return; if(p.gpa!=null) gpa.value=p.gpa; if(p.major!=null) major.value=p.major; if(p.system!=null) system.value=p.system; if(p.minrate!=null) minrate.value=p.minrate; }
    function profileToQuery(p){ return `${location.pathname}?${new URLSearchParams(p).toString()}`; }
    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      const p = getProfile(); setJSON(LS_KEYS.PROFILE, p);
      const link = location.origin + profileToQuery(p);
      try{ await navigator.clipboard.writeText(link); alert('Shareable link copied!\n'+link);}catch{ prompt('Copy link:', link); }
      history.replaceState(null,'',profileToQuery(p));
    });

    // ===== Analysis & render =====
    function analyze(){
      const g = parseFloat(gpa.value);
      const m = (major.value||'').trim();
      const sys = document.getElementById('system').value;
      const minR = parseInt(document.getElementById('minrate').value,10)||0;

      const rows = COLLEGES
        .filter(c => (sys==='ALL' ? true : c.system===sys))
        .filter(c => c.admitRate >= minR)
        .filter(c => !m || c.majors.includes(m))
        .map((c, idx) => {
          const mid = getMidpoint(c, m);
          const fit = classify(g, mid);
          return { id:idx, name:c.name, system:c.system, rate:c.admitRate, mid, fit, gpa:g };
        })
        .sort((a,b)=>a.mid-b.mid);

      renderTable(rows, m);
    }

    function renderTable(rows, majorVal){
      const el = document.getElementById('results');
      if (!rows.length){ el.innerHTML = '<p class="note">No results yet. Enter GPA, choose a major, and click Show Results.</p>'; document.getElementById('count').textContent='No results'; return; }

      const thead = `<thead><tr>
        <th>College</th><th>Fit</th><th>Midpoint GPA</th><th>Admit rate</th><th>Actions</th>
      </tr></thead>`;

      const tbody = rows.map(r=>{
        const tag = fitTagClass(r.fit.band);
        const why = reasonText({gpa:r.gpa, mid:r.mid, band:r.fit.band, name:r.name, major:majorVal});
        const starred = isBookmarked(r.name, majorVal);
        return `<tr id="row-${r.id}">
          <td>${r.name}<div class="note">${r.system}</div></td>
          <td><span class="tag ${tag}">${r.fit.band}</span></td>
          <td>${r.mid.toFixed(2)}</td>
          <td>${r.rate}%</td>
          <td>
            <button class="mini-link" data-why="${r.id}">Why?</button>
            <a class="mini-link" target="_blank" href="${admissionsUrl(r.name)}">Admissions</a>
            <span class="mini-link star ${starred?'filled':''}" data-star="${r.id}">‚òÖ</span>
            <div class="why" id="why-${r.id}" style="display:none">${why}</div>
          </td>
        </tr>`;
      }).join('');

      el.innerHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`;
      document.getElementById('count').textContent = `${rows.length} result${rows.length===1?'':'s'}`;

      document.querySelectorAll('[data-why]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-why');
          const panel = document.getElementById('why-'+id);
          const visible = panel.style.display==='block';
          panel.style.display = visible?'none':'block';
          btn.textContent = visible?'Why?':'Hide';
        });
      });

      document.querySelectorAll('[data-star]').forEach(st=>{
        st.addEventListener('click',()=>{
          const id = st.getAttribute('data-star');
          const row = document.getElementById('row-'+id);
          const name = row.children[0].firstChild.textContent.trim();
          const band = row.querySelector('.tag').textContent.trim();
          const system = row.children[0].querySelector('.note').textContent.trim();
          const mid = parseFloat(row.children[2].textContent);
          const rate = parseInt(row.children[3].textContent,10);
          const gpaVal = parseFloat(gpa.value);
          const majorVal2 = (major.value||'').trim();
          const bm = {name, system, rate, mid, band, gpa:gpaVal, major: majorVal2, ts: Date.now()};
          if (isBookmarked(name, majorVal2)) { removeBookmark(name, majorVal2); st.classList.remove('filled'); }
          else { addBookmark(bm); st.classList.add('filled'); }
        });
      });

      renderBookmarks();
    }

    // Drawer + buttons
    const drawer = document.getElementById('drawer');
    document.getElementById('bmBtn').addEventListener('click', ()=> drawer.classList.toggle('open'));
    document.getElementById('closeDrawer').addEventListener('click', ()=> drawer.classList.remove('open'));
    document.getElementById('clearBms').addEventListener('click', ()=> saveBookmarks([]));

    document.getElementById('toggleDetails').addEventListener('click', ()=>{ document.querySelectorAll('.why').forEach(w=>{ w.style.display = (w.style.display==='block')? 'none':'block'; }); });

    // Init
    (async function init(){
      await say('Start with your weighted GPA.');
      const q = Object.fromEntries(new URL(location.href).searchParams.entries());
      if (Object.keys(q).length) { applyProfile(q); }
      else { const p = getJSON(LS_KEYS.PROFILE, null); applyProfile(p); }
      if (!gpa.value) gpa.value = '4.00';
      if (!major.value) major.value = '';
    })();
  </script>
</body>
</html>
